import CreateHTMLElement from"../CreateHTMLElement.js";import Lisener from"../../Lisener/Lisener.js";import Fetch from"../../api/Fetch.js";import Valid from"../../functionForValid/Valid.js";import showNoVisitText from"../../function/showNoVisitText.js";import{getDataPatient}from"../../function/localStorage.js";export default class Button extends CreateHTMLElement{constructor({className:t,id:e,type:i="",text:s="","aria-label":r="","data-dismiss":a=""}){super(t,e),this.type=i,this.text=s,this.ariaLabel=r,this.dataDismiss=a}render(t,e,i=null){this.createButton(),this.addElement(t,e),this.className.includes("close")&&this.listenerBtnClose(i),this.className.includes("edit-btn")&&this.lisenerBtnEdit(i)}createButton(){this.createElement({name:"button",attributes:{type:this.type,innerHTML:this.text,"aria-label":this.ariaLabel,"data-dismiss":this.dataDismiss}})}stopScroll(){const t=document.querySelector("body");t.classList.add("stop-scroll"),t.querySelector(".main__block-for-form").classList.remove("block-for-form")}removeWithLocalStorage(t){const e=getDataPatient().filter((e=>e.id!==t));localStorage.setItem("patient",JSON.stringify(e)),0===e.length&&showNoVisitText(document.querySelector(".cards-wrapper"))}closeForm(t,e){const i=e.closest(t);if(".main__form"===t||"#exampleModalCenter"===t){const t=document.getElementById("exampleModalCenter");document.body.className="",t.classList.remove("show"),t.style.cssText="",document.querySelector(".modal-backdrop").remove()}else if(i.id.includes("card")){const t=parseInt(i.id.split("-").reverse().join(" "));Fetch.deleteCard(t).then((()=>{this.removeWithLocalStorage(t),i.remove()}))}i.remove()}isValidNewData(t,e,i){new Valid(t,i).render(e)}editWithLocalStorage(t){const e=getDataPatient().map((e=>e.id===t.id?e=t:e));localStorage.setItem("patient",JSON.stringify(e))}async saveEditCard(t,e,i){const s=await Fetch.putCard(t,i);e.forEach(this.removeAttribute),this.editWithLocalStorage(s)}removeAttribute(t){t.removeAttribute("contenteditable"),t.classList.remove("border")}setAttribute(t){t.setAttribute("contenteditable","true"),t.classList.add("border")}editTextCard(t,e){if(t.classList.contains("edit-btn")){const i=e.currentTarget,s=parseInt(i.id.split("-").reverse().join(" ")),r=i.querySelectorAll("p");let a=null;t.innerHTML="Сохранить";const o=[...r].reduce(((t,e)=>{let i=e.dataset.patient,s=e.innerHTML;return e.getAttribute("contenteditable")?(this.isValidNewData(s,i,e),a=!0):(this.setAttribute(e),e.classList.add("text")),t[i]=s,t}),{});!i.querySelector(".main__not-valid-input")&&a&&(t.innerHTML="Редактировать",this.saveEditCard(o,r,s))}}lisenerBtnEdit(t){Lisener.render(t,"click",this.editTextCard.bind(this))}listenerBtnClose(t){document.querySelector(t).addEventListener("click",(e=>{"SPAN"===e.target.tagName&&this.closeForm(t,e.target)}))}}